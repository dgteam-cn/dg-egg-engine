module.exports = {
    // json5 自动解析，适用于
    JSON5_PARSE: [
        "/**",
        " * 自动加载外部文件对 JSON 进行序列化",
        " * 使用 bootcdn 的 cdn 加速",
        " */",
        "const cdnURL = 'https://cdn.bootcdn.net/ajax/libs/json5/2.2.1/index.js'",
        "function serializeJSON5() {",
        "    if (~['POST', 'PUT', 'DELETE'].indexOf(pm.request.method)) {",
        "        const json5Code = pm.globals.get('JSON5-Script')",
        "        eval(json5Code)",
        "        const JSON5 = this.JSON5        ",
        "        const {mode, raw} = pm.request.body",
        "        if (mode === 'raw' && raw) {",
        "            try {",
        "                if (pm.request.body.options.raw.language === 'json') {",
        "                    pm.request.body.raw = JSON.stringify(JSON5.parse(raw))",
        "                }",
        "            } catch (e) {",
        "                console.log('JSON5 parse error.')",
        "            }",
        "        }",
        "    }",
        "}",
        "if (!pm.globals.has('JSON5-Script')) {",
        "    pm.sendRequest(cdnURL, function(err, res) {",
        "        if (!err) {",
        "            pm.globals.set('JSON5-Script', res.text())",
        "            serializeJSON5() // pm.sendRequest 会自动阻塞运行直到请求完成",
        "        } else {",
        "            console.log('JSON5 cdn request error.')",
        "        }",
        "    })",
        "} else {",
        "    serializeJSON5()",
        "}",
        "// 20220819 解决新版在 :id 为空时，原样数据导致接口解析错误的问题",
        "pm.request.url.path.forEach((path, index) => {",
        "    if (path && path[0] === ':') {",
        "        const key = path.slice(1)",
        "        const variable = pm.request.url.variables.find(row => row.key === key)",
        "        if (variable && variable.value == '') {",
        "            pm.request.url.path[index] = ''",
        "        }",
        "    }",
        "})"
    ]
}

